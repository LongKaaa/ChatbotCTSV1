<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIT @ HCMUS | THE SINGULARITY</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/studio-freight/lenis@1.0.29/bundled/lenis.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Space+Grotesk:wght@300;400;500;700&family=Montserrat:wght@800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- 0. CONFIG --- */
        :root {
            --c-black: #050505;
            --c-blue: #3b82f6;
            --c-cyan: #06b6d4;
            --c-white: #ffffff;
            --font-display: 'Syncopate', sans-serif;
            --font-body: 'Space Grotesk', sans-serif;
        }

        * { box-sizing: border-box; cursor: none; /* Tắt chuột mặc định */ }
        
        body {
            margin: 0; padding: 0; background-color: var(--c-black);
            color: var(--c-white); font-family: var(--font-body);
            overflow-x: hidden;
        }

        /* --- 1. NEW CURSOR (Dấu cộng Neon) --- */
        #cursor {
            position: fixed; top: 0; left: 0; width: 30px; height: 30px;
            pointer-events: none; z-index: 99999; transform: translate(-50%, -50%);
            display: flex; align-items: center; justify-content: center;
        }
        /* Tạo hình dấu cộng */
        #cursor::before, #cursor::after {
            content: ''; position: absolute; background: white;
            transition: 0.3s; box-shadow: 0 0 10px white;
        }
        #cursor::before { width: 100%; height: 2px; } /* Ngang */
        #cursor::after { width: 2px; height: 100%; } /* Dọc */

        /* Khi hover */
        body.hovering #cursor {
            width: 50px; height: 50px; transform: translate(-50%, -50%) rotate(45deg); /* Xoay 45 độ thành dấu X */
        }
        body.hovering #cursor::before, body.hovering #cursor::after {
            background: var(--c-cyan); box-shadow: 0 0 15px var(--c-cyan);
        }

        /* --- 2. 3D BACKGROUND --- */
        #webgl-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; opacity: 0; transition: opacity 2s ease;
        }
        body.loaded #webgl-canvas { opacity: 1; }

        /* --- 3. PRELOADER --- */
        #preloader {
            position: fixed; inset: 0; background: #000; z-index: 99999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .loader-text {
            font-family: var(--font-display); font-weight: 700; font-size: 2rem;
            letter-spacing: 10px; color: transparent; -webkit-text-stroke: 1px white; opacity: 0.5;
        }
        .loader-bar {
            width: 0%; height: 2px; background: var(--c-blue);
            margin-top: 20px; transition: width 0.1s; box-shadow: 0 0 20px var(--c-blue);
        }
        .loader-percent { font-family: var(--font-body); font-size: 12px; margin-top: 10px; color: #666; }

        /* --- 4. TYPOGRAPHY --- */
        .section { position: relative; width: 100%; padding: 10vh 5vw; }
        .hero-section { height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .big-text {
            font-family: 'Montserrat', sans-serif; font-size: 12vw; line-height: 0.8;
            text-transform: uppercase; font-weight: 900; letter-spacing: -0.05em;
            color: transparent; -webkit-text-stroke: 2px rgba(255,255,255,0.8);
            position: relative; z-index: 10; pointer-events: none;
        }
        .big-text.filled { color: white; -webkit-text-stroke: 0; mix-blend-mode: exclusion; }
        .subtitle {
            font-family: var(--font-display); font-size: 1rem; letter-spacing: 0.2em;
            color: var(--c-blue); margin-bottom: 2rem; display: block;
        }

        /* --- 5. UI & NAV --- */
        nav {
            position: fixed; top: 0; left: 0; width: 100%; padding: 40px;
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
            mix-blend-mode: difference;
        }
        .logo { font-family: var(--font-display); font-weight: 700; font-size: 1.5rem; letter-spacing: 2px; }
        
        .btn-glitch {
            position: relative; padding: 15px 40px; background: transparent;
            border: 1px solid rgba(255,255,255,0.3); color: white;
            font-family: var(--font-display); font-size: 10px; letter-spacing: 2px;
            text-transform: uppercase; overflow: hidden; transition: 0.3s;
        }
        .btn-glitch:hover { background: white; color: black; border-color: white; }
        
        .noise {
            position: fixed; inset: 0; z-index: 9000; pointer-events: none; opacity: 0.07;
            background: url('https://grainy-gradients.vercel.app/noise.svg');
        }

        /* --- 6. CHATBOT INTERFACE (NEW DESIGN: DEEP BLUE & NEON) --- */
        #chat-interface {
            position: fixed; inset: 0; z-index: 10000;
            /* Thay đổi nền từ đen xám sang Xanh đen vũ trụ */
            background: rgba(2, 6, 23, 0.85); 
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            transform: translateY(100%); transition: transform 1s cubic-bezier(0.77, 0, 0.175, 1);
            display: flex; flex-direction: column;
        }
        #chat-interface.active { transform: translateY(0); }
        
        /* Hiệu ứng nền chat ảo diệu */
        .chat-glow {
            position: absolute; width: 500px; height: 500px; background: var(--c-blue);
            filter: blur(150px); opacity: 0.2; border-radius: 50%; top: -10%; left: -10%; z-index: -1;
        }

        .chat-header {
            padding: 30px 50px; border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.2);
        }
        
        .chat-body { flex-grow: 1; display: flex; overflow: hidden; position: relative; }
        
        /* Sidebar mới: Đen mờ sang trọng */
        .chat-sidebar {
            width: 350px; border-right: 1px solid rgba(255,255,255,0.1); padding: 40px;
            display: flex; flex-direction: column; background: rgba(0, 0, 0, 0.4);
            transform: translateX(-100%); transition: transform 1s 0.2s cubic-bezier(0.19, 1, 0.22, 1);
        }
        #chat-interface.active .chat-sidebar { transform: translateX(0); }

        /* Main Chat Area */
        .chat-main { flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        .messages-container {
            flex-grow: 1; overflow-y: auto; padding: 50px 10%; display: flex; flex-direction: column; gap: 40px;
        }
        
        .msg { opacity: 0; transform: translateY(20px); animation: fadeUp 0.5s forwards; display: flex; gap: 20px; }
        @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
        
        /* Bong bóng chat mới */
        .msg-avatar {
            width: 40px; height: 40px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-size: 14px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .msg-avatar.ai { background: linear-gradient(135deg, #00c6ff, #0072ff); color: white; }
        .msg-avatar.user { background: #333; color: #fff; border: 1px solid #555; }

        .msg-content { 
            max-width: 800px; font-size: 1.1rem; line-height: 1.6; 
            padding: 20px 25px; border-radius: 20px; position: relative;
        }
        
        /* Style cho AI: Trong suốt viền sáng */
        .msg.ai .msg-content {
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e2e8f0; border-top-left-radius: 4px;
        }
        /* Style cho User: Gradient xanh */
        .msg.user { flex-direction: row-reverse; }
        .msg.user .msg-content { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: white; border-top-right-radius: 4px;
            box-shadow: 0 5px 20px rgba(37, 99, 235, 0.3);
        }

        /* Input Area */
        .input-area {
            padding: 40px 10%; border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; gap: 20px; align-items: flex-end; background: rgba(0,0,0,0.3);
        }
        #chat-input {
            width: 100%; background: transparent; border: none; border-bottom: 2px solid rgba(255,255,255,0.2);
            padding: 20px 0; color: white; font-family: var(--font-body); font-size: 1.2rem;
            outline: none; transition: 0.3s;
        }
        #chat-input:focus { border-color: var(--c-cyan); }
        .send-btn { color: var(--c-cyan); font-size: 2rem; cursor: pointer; transition: 0.3s; }
        .send-btn:hover { color: white; transform: translateX(5px); }

        /* --- 7. SPECIAL SECTIONS --- */
        .marquee-container {
            background: var(--c-blue); color: black; padding: 5vh 0;
            transform: rotate(-2deg) scale(1.1); margin: 10vh 0;
        }
        .marquee-text {
            font-family: var(--font-big); font-size: 5vw; white-space: nowrap; font-weight: 900;
        }

        .card-item {
            position: relative; border-top: 1px solid rgba(255,255,255,0.2);
            padding: 50px 0; transition: 0.3s; display: flex; justify-content: space-between; align-items: center;
        }
        .card-item:hover { padding-left: 20px; background: rgba(255,255,255,0.02); }
        .card-item h3 { font-family: var(--font-display); font-size: 3rem; margin: 0; }
        .card-item span { font-family: var(--font-body); color: var(--c-blue); }
        
        .hover-reveal {
            position: fixed; width: 300px; height: 400px; top: 0; left: 0;
            pointer-events: none; z-index: 50; opacity: 0; transform: scale(0.8);
            transition: opacity 0.3s, transform 0.3s; mix-blend-mode: difference;
        }
        .hover-reveal img { width: 100%; height: 100%; object-fit: cover; }

    </style>
</head>
<body>

    <audio id="sfx-hover" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.m4a"></audio>
    <audio id="sfx-open" src="https://assets.mixkit.co/active_storage/sfx/2044/2044-preview.m4a"></audio>

    <div class="noise"></div>
    <div id="cursor"></div> <div id="preloader">
        <div class="loader-text">FIT SYSTEM</div>
        <div style="width: 300px"><div class="loader-bar"></div></div>
        <div class="loader-percent">0%</div>
    </div>

    <div id="webgl-canvas"></div>

    <div id="chat-interface">
        <div class="chat-glow"></div> <div class="chat-header">
            <div class="flex items-center gap-4">
                <div class="w-3 h-3 bg-cyan-400 rounded-full animate-pulse shadow-[0_0_10px_#22d3ee]"></div>
                <span class="font-bold tracking-widest text-sm text-cyan-400">FIT.AI <span class="text-white opacity-50">v2.0</span></span>
            </div>
            <button onclick="toggleChat()" class="btn-glitch hover-trigger">ĐÓNG</button>
        </div>

        <div class="chat-body">
            <div class="chat-sidebar">
                <div>
                    <p class="text-blue-400 text-xs font-bold mb-6 tracking-widest uppercase">Câu hỏi nhanh</p>
                    <div class="flex flex-col gap-4">
                        <button onclick="sendQuick('Điểm chuẩn 2025?')" class="text-left text-lg hover:text-cyan-400 transition hover-trigger text-gray-400">Điểm chuẩn 2025</button>
                        <button onclick="sendQuick('Học phí năm nay?')" class="text-left text-lg hover:text-cyan-400 transition hover-trigger text-gray-400">Học phí các ngành</button>
                        <button onclick="sendQuick('Cơ hội việc làm ngành AI?')" class="text-left text-lg hover:text-cyan-400 transition hover-trigger text-gray-400">Cơ hội việc làm ngành AI</button>
                    </div>
                </div>
                <div class="mt-auto">
                    <div class="w-full h-[1px] bg-white/10 mb-4"></div>
                    <p class="text-xs text-gray-500">Powered by Gemini 2.5</p>
                </div>
            </div>

            <div class="chat-main">
                <div id="chat-history" class="messages-container" data-lenis-prevent>
                    <div class="msg ai">
                        <div class="msg-avatar ai"><i class="fa-solid fa-robot"></i></div>
                        <div class="msg-content">
                            Xin chào. Tôi là trí tuệ nhân tạo của FIT HCMUS. <br>
                            Hệ thống dữ liệu tuyển sinh 2025 đã sẵn sàng.
                        </div>
                    </div>
                </div>
                <div class="input-area">
                    <textarea id="chat-input" rows="1" placeholder="Đặt câu hỏi của bạn ở đây" class="hover-trigger"></textarea>
                    <button id="btn-send" class="send-btn hover-trigger"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <nav>
        <div class="logo hover-trigger">FIT<span class="text-blue-600">.</span>HCMUS</div>
        <div class="hidden md:flex gap-12 text-xs font-bold tracking-widest">
            <a href="#majors" class="hover-trigger">PROGRAMS</a>
            <a href="#stats" class="hover-trigger">STATS</a>
            <a href="#footer" class="hover-trigger">CONTACT</a>
        </div>
        <button onclick="toggleChat()" class="btn-glitch hover-trigger">CHAT CÙNG AI</button>
    </nav>

    <main id="main-content">
        
        <section class="hero-section">
            <div class="relative z-10 text-center">
                <span class="subtitle">ADMISSIONS 2025 - 2026</span>
                <h1 class="big-text skew-on-scroll">FIT</h1>
                <h1 class="big-text filled skew-on-scroll">HCMUS</h1>
                <p class="mt-10 text-gray-400 max-w-lg mx-auto leading-relaxed">
                    Khoa Công nghệ Thông tin - ĐH Khoa học Tự nhiên. <br>
                    Nơi hội tụ những bộ óc kiến tạo tương lai. <br>
                    Hỗ trỡ sinh viên với ChatbotAI tự động.
                </p>
            </div>
        </section>

        <div class="marquee-container">
            <div class="marquee-inner flex gap-10">
                <span class="marquee-text">COMPUTER SCIENCE — ARTIFICIAL INTELLIGENCE — SOFTWARE ENGINEERING — DATA SCIENCE — </span>
                <span class="marquee-text">COMPUTER SCIENCE — ARTIFICIAL INTELLIGENCE — SOFTWARE ENGINEERING — DATA SCIENCE — </span>
            </div>
        </div>

        <section id="majors" class="section">
            <div class="flex justify-between items-end mb-20">
                <h2 class="text-6xl font-bold font-display">ACADEMIC<br>UNIVERSE</h2>
                <p class="text-right text-gray-500">Khám phá các chương trình <br>đào tạo chuẩn quốc tế.</p>
            </div>

            <div class="border-b border-white/20">
                <div class="card-item hover-trigger" data-img="https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=2070">
                    <div>
                        <span class="block text-xs text-blue-600 mb-2 font-mono">01 / MAJOR</span>
                        <h3>Computer Science</h3>
                    </div>
                    <div class="text-right">
                        <span class="block text-xl">Khoa học máy tính</span>
                        <button onclick="toggleChat()" class="text-xs mt-2 underline">ASK AI ></button>
                    </div>
                </div>
                <div class="card-item hover-trigger" data-img="https://images.unsplash.com/photo-1677442136019-21780ecad995?q=80&w=2070">
                    <div>
                        <span class="block text-xs text-green-500 mb-2 font-mono">02 / MAJOR</span>
                        <h3>Artificial Intel.</h3>
                    </div>
                    <div class="text-right">
                        <span class="block text-xl">Trí tuệ nhân tạo</span>
                        <button onclick="toggleChat()" class="text-xs mt-2 underline">ASK AI ></button>
                    </div>
                </div>
            </div>
        </section>

        <div class="hover-reveal"><img src="" id="reveal-img"></div>

        <section class="section" style="padding: 20vh 5vw;">
            <div class="w-full border-t border-white/20 mb-10"></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-20">
                <div>
                    <h2 class="text-5xl font-bold mb-10">THE #1 TECH HUB <br> IN SOUTH VIETNAM</h2>
                    <p class="text-gray-400 text-lg leading-relaxed mb-10">
                        Với mạng lưới hơn 50 đối tác toàn cầu, FIT HCMUS mang đến cơ hội thực tập và làm việc tại các tập đoàn công nghệ hàng đầu như Google, Microsoft, VNG...
                    </p>
                    <div class="grid grid-cols-2 gap-10">
                        <div>
                            <span class="text-4xl font-bold text-blue-500 block mb-2 counter" data-target="98%">0</span>
                            <span class="text-xs uppercase tracking-widest text-gray-500">Employment Rate</span>
                        </div>
                        <div>
                            <span class="text-4xl font-bold text-blue-500 block mb-2 counter" data-target="50">0</span>
                            <span class="text-xs uppercase tracking-widest text-gray-500">Global Partners</span>
                        </div>
                    </div>
                </div>
                <div class="relative h-[600px] w-full overflow-hidden rounded-lg hover-trigger">
                    <img src="https://hcmus.edu.vn/wp-content/uploads/slider/cache/fae88e4b6d9af954c9e28e1f58335483/FB-COVER-scaled.jpg" class="w-full h-full object-cover grayscale hover:grayscale-0 transition duration-700">
                </div>
            </div>
        </section>

        <section id="footer" class="h-screen flex flex-col justify-center items-center text-center relative">
            <span class="subtitle">END OF LINE</span>
            <h2 class="big-text filled cursor-pointer hover-trigger" onclick="toggleChat()">JOIN US</h2>
            <div class="mt-10">
                <button onclick="toggleChat()" class="btn-glitch hover-trigger" style="font-size: 1.5rem; padding: 25px 60px;">CHAT CÙNG AI</button>
            </div>
            
            <footer class="absolute bottom-10 w-full flex justify-between px-10 text-xs text-gray-600 font-bold tracking-widest uppercase">
                <div>© 2025 FIT.HCMUS</div>
                <div>Designed by Bộ PC & AI</div>
            </footer>
        </section>

    </main>

    <script>
        // --- 1. AUDIO SYSTEM ---
        const sfx = {
            hover: document.getElementById('sfx-hover'),
            open: document.getElementById('sfx-open')
        };
        sfx.hover.volume = 0.2;

        document.querySelectorAll('.hover-trigger').forEach(el => {
            el.addEventListener('mouseenter', () => {
                sfx.hover.currentTime = 0; sfx.hover.play().catch(()=>{});
                document.body.classList.add('hovering');
            });
            el.addEventListener('mouseleave', () => document.body.classList.remove('hovering'));
        });

       // --- 2. CUSTOM CURSOR (INSTANT SPEED) ---
        const cursor = document.getElementById('cursor');
        window.addEventListener('mousemove', (e) => {
            // Thay 'gsap.to' thành 'gsap.set' để di chuyển TỨC THÌ theo chuột
            gsap.set(cursor, { x: e.clientX, y: e.clientY });
            
            // Hover Reveal Logic (Giữ nguyên phần hiển thị ảnh)
            const reveal = document.querySelector('.hover-reveal');
            const target = e.target.closest('.card-item');
            
            if(target) {
                const img = target.dataset.img;
                document.getElementById('reveal-img').src = img;
                // Ảnh thì vẫn nên có độ trễ một chút cho mượt (duration: 0.3)
                gsap.to(reveal, { opacity: 1, scale: 1, x: e.clientX + 20, y: e.clientY + 20, duration: 0.3 });
            } else {
                gsap.to(reveal, { opacity: 0, scale: 0.8, duration: 0.3 });
            }
        });

        // --- 3. PRELOADER & INIT ---
        let loadProg = 0;
        const loaderBar = document.querySelector('.loader-bar');
        const loaderPercent = document.querySelector('.loader-percent');
        
        const loadInt = setInterval(() => {
            loadProg += Math.random() * 5;
            if(loadProg > 100) loadProg = 100;
            loaderBar.style.width = loadProg + '%';
            loaderPercent.innerText = Math.floor(loadProg) + '%';
            
            if(loadProg === 100) {
                clearInterval(loadInt);
                gsap.to('#preloader', { yPercent: -100, duration: 1.5, ease: 'expo.inOut', delay: 0.5 });
                initThreeJS();
                document.body.classList.add('loaded');
            }
        }, 20);

        // --- 4. THREE.JS STARFIELD WARP (NỀN 3D) ---
        function initThreeJS() {
            const container = document.createElement('div');
            document.body.appendChild(container);
            container.id = 'webgl-canvas';

            const scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.002);

            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 100;

            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);

            // Particles
            const geometry = new THREE.BufferGeometry();
            const count = 5000;
            const positions = new Float32Array(count * 3);
            const speeds = new Float32Array(count);

            for(let i = 0; i < count; i++) {
                positions[i*3] = (Math.random() - 0.5) * 2000;
                positions[i*3+1] = (Math.random() - 0.5) * 2000;
                positions[i*3+2] = (Math.random() - 0.5) * 2000;
                speeds[i] = Math.random();
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const material = new THREE.PointsMaterial({ color: 0x3b82f6, size: 2, sizeAttenuation: true });
            const points = new THREE.Points(geometry, material);
            scene.add(points);

            // Post Processing (Bloom)
            const composer = new THREE.EffectComposer(renderer);
            const renderPass = new THREE.RenderPass(scene, camera);
            composer.addPass(renderPass);
            const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0; bloomPass.strength = 1.2; bloomPass.radius = 0;
            composer.addPass(bloomPass);

            const animate = () => {
                requestAnimationFrame(animate);
                
                const scrollSpeed = lenis.velocity || 0;
                const speedMulti = 1 + Math.abs(scrollSpeed * 0.1);
                
                const pos = geometry.attributes.position.array;
                for(let i = 0; i < count; i++) {
                    pos[i*3+2] += (2 * speeds[i]) * speedMulti; 
                    if(pos[i*3+2] > 200) pos[i*3+2] = -2000;
                }
                geometry.attributes.position.needsUpdate = true;
                points.rotation.z += 0.001 * speedMulti;

                composer.render();
            };
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // --- 5. SMOOTH SCROLL ---
        const lenis = new Lenis({ duration: 1.5, smooth: true });
        function raf(time) { lenis.raf(time); requestAnimationFrame(raf); }
        requestAnimationFrame(raf);

        gsap.registerPlugin(ScrollTrigger);

        gsap.to(".marquee-inner", {
            xPercent: -50, ease: "none",
            scrollTrigger: { trigger: ".marquee-container", start: "top bottom", end: "bottom top", scrub: 0.5 }
        });

        lenis.on('scroll', (e) => {
            const skew = e.velocity * 0.1;
            gsap.to('.skew-on-scroll', { skewY: skew, duration: 0.5 });
        });

        gsap.utils.toArray('.counter').forEach(counter => {
            const target = counter.getAttribute('data-target').includes('%') ? 98 : 50;
            const suffix = counter.getAttribute('data-target').includes('%') ? '%' : '+';
            gsap.to(counter, {
                innerText: target, duration: 2, snap: { innerText: 1 },
                scrollTrigger: { trigger: counter, start: "top 80%" },
                onUpdate: function() { counter.innerText = Math.ceil(this.targets()[0].innerText) + suffix }
            });
        });

        // --- 6. CHATBOT LOGIC ---
        const chatUI = document.getElementById('chat-interface');
        const userInput = document.getElementById('chat-input');
        const chatHistory = document.getElementById('chat-history');
        let chatOpen = false;

        function toggleChat() {
            chatOpen = !chatOpen;
            if(chatOpen) {
                chatUI.classList.add('active');
                lenis.stop();
                sfx.open.play().catch(()=>{});
                setTimeout(() => userInput.focus(), 800);
            } else {
                chatUI.classList.remove('active');
                lenis.start();
            }
        }

        function sendQuick(msg) { userInput.value = msg; sendMessage(); }

        async function sendMessage() {
            const msg = userInput.value.trim();
            if(!msg) return;

            chatHistory.insertAdjacentHTML('beforeend', `
                <div class="msg user">
                    <div class="msg-content">${msg}</div>
                    <div class="msg-avatar user"><i class="fa-solid fa-user"></i></div>
                </div>
            `);
            userInput.value = '';
            chatHistory.scrollTop = chatHistory.scrollHeight;

            const loadId = 'load-'+Date.now();
            chatHistory.insertAdjacentHTML('beforeend', `
                <div class="msg ai" id="${loadId}">
                    <div class="msg-avatar ai"><i class="fa-solid fa-circle-notch fa-spin"></i></div>
                    <div class="msg-content text-gray-400">Thinking...</div>
                </div>
            `);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            /* --- FILE: index.html (Trong hàm sendMessage) --- */

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message: msg})
                });
                const data = await res.json();
                document.getElementById(loadId).remove();
                
                // --- XỬ LÝ TEXT: LÀM SẠCH TRIỆT ĐỂ ---
                let cleanText = data.response;

                // 1. Xóa các ký tự xuống dòng ở đầu và cuối chuỗi
                cleanText = cleanText.trim();

                // 2. Gộp TẤT CẢ các dòng trống liên tiếp (>2 dòng) thành đúng 2 dòng (<br><br>)
                // Điều này ngăn chặn việc AI "lỡ tay" enter quá nhiều
                cleanText = cleanText.replace(/(\r\n|\r|\n){2,}/g, '$1$1');

                // 3. Chuyển đổi \n thành thẻ <br> để hiển thị
                let formattedText = cleanText.replace(/\n/g, '<br>');
                // ------------------------------------------

                chatHistory.insertAdjacentHTML('beforeend', `
                    <div class="msg ai">
                        <div class="msg-avatar ai"><i class="fa-solid fa-brain"></i></div>
                        <div class="msg-content">${formattedText}</div>
                    </div>
                `);
                
                // Cuộn xuống đáy mượt mà
                setTimeout(() => {
                    chatHistory.scrollTo({
                        top: chatHistory.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 50);

            } catch(e) { console.error(e); }
        }

        document.getElementById('btn-send').addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });

    </script>
</body>
</html>